name: v3 v4 Image Builds from template
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  getNordvpnVersions:
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v4
      - name: get local nordvpn client version
        run: |
          grep -oP "(?<=changelog\): )[^ ]+" README.md | tr -d ' '
          echo "VERSION="$(grep -oP "(?<=changelog\): )[^ ]+" README.md | tr -d ' ') >> $GITHUB_ENV
  build-v3-images:
    uses: ./.github/workflows/build-template.yml
    with:
      build-context: '.'
      tbt_version: "3.00"
      tag: "edgd1er/nordlynx-transmission:v3"
    secrets: inherit
    needs: getNordvpnVersions

  build-v4-images:
    uses: ./.github/workflows/build-template.yml
    with:
      build-context: '.'
      tbt_version: "4.0.5"
      tag: "edgd1er/nordlynx-transmission:v4,edgd1er/nordlynx-transmission:latest"
    secrets: inherit
    needs: getNordvpnVersions

  build-v4dev-images:
    uses: ./.github/workflows/build-template.yml
    with:
      build-context: '.'
      tbt_version: "dev"
      tag: "edgd1er/nordlynx-transmission:dev"
      ptf: "linux/amd64,linux/arm64,linux/arm/v7"
    secrets: inherit
    needs: getNordvpnVersions